<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>JS Drum Kit</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div class="loop-container">
            <label for="loopDelay">Delay</label><br/>
            <input type="range" id="loopDelay" name="loopDelay" min="100" max="500" value="200"/><br/>
            <input type="text" maxlength="16" name="loop"/>
        </div>

        <div class="keys">
            <div data-key="65" class="key">
                <kbd>A</kbd>
                <span class="sound">clap</span>
            </div>
            <div data-key="83" class="key">
                <kbd>S</kbd>
                <span class="sound">hihat</span>
            </div>
            <div data-key="68" class="key">
                <kbd>D</kbd>
                <span class="sound">kick</span>
            </div>
            <div data-key="70" class="key">
                <kbd>F</kbd>
                <span class="sound">openhat</span>
            </div>
            <div data-key="71" class="key">
                <kbd>G</kbd>
                <span class="sound">boom</span>
            </div>
            <div data-key="72" class="key">
                <kbd>H</kbd>
                <span class="sound">ride</span>
            </div>
            <div data-key="74" class="key">
                <kbd>J</kbd>
                <span class="sound">snare</span>
            </div>
            <div data-key="75" class="key">
                <kbd>K</kbd>
                <span class="sound">tom</span>
            </div>
            <div data-key="76" class="key">
                <kbd>L</kbd>
                <span class="sound">tink</span>
            </div>
        </div>

        <audio data-key="65" src="sounds/clap.wav"></audio>
        <audio data-key="83" src="sounds/hihat.wav"></audio>
        <audio data-key="68" src="sounds/kick.wav"></audio>
        <audio data-key="70" src="sounds/openhat.wav"></audio>
        <audio data-key="71" src="sounds/boom.wav"></audio>
        <audio data-key="72" src="sounds/ride.wav"></audio>
        <audio data-key="74" src="sounds/snare.wav"></audio>
        <audio data-key="75" src="sounds/tom.wav"></audio>
        <audio data-key="76" src="sounds/tink.wav"></audio>

        <script>
            HTMLAudioElement.prototype.rewind = function () {
                this.currentTime = 0;
            };

            HTMLAudioElement.prototype.playImmediately = function () {
                this.rewind();
                this.play();
            };

            class Drumkit {
                enable() {
                    this
                        .getKeys()
                        .forEach(key => key.addEventListener('transitionend', e => this.removeTransition(e)));

                    window.addEventListener('keydown', e => this.maybePlaySound(e));
                }

                getElementByKeyCode(elementType, keyCode) {
                    const selector = `${elementType}[data-key="${keyCode}"]`;
                    const element = document.querySelector(selector);

                    return element;
                }

                maybePlaySound(e) {
                    const audio = this.getElementByKeyCode('audio', e.keyCode);

                    if (!audio) {
                        return;
                    }

                    const key = this.getElementByKeyCode('div', e.keyCode);

                    key.classList.add('playing');

                    // Allow for playing one after another
                    audio.playImmediately();
                }

                removeTransition(e) {
                    if (e.propertyName !== 'transform') {
                        return;
                    }

                    e.target.classList.remove('playing');
                }

                getKeys() {
                    const keys = document.querySelectorAll('.key');
                    return keys;
                }
            }

            class Loop {
                constructor(keys, delay) {
                    this.setDelay(delay);
                    this.setKeys(keys)
                    keys.addEventListener('keyup', (e) => this.updateKeys(e));
                    delay.addEventListener('change', (e) => this.updateDelay(e));
                }

                setKeys(keysInput) {
                    this.keys = this.padEnd(keysInput.value, 16).split('');
                    this.resetLoop();
                }

                getKeyCodeFromLetter(letter) {
                    switch (letter.toLowerCase()) {
                        case 'a':
                            return 65;
                        case 's':
                            return 83;
                        case 'd':
                            return 68;
                        case 'f':
                            return 70;
                        case 'g':
                            return 71;
                        case 'h':
                            return 72;
                        case 'j':
                            return 74;
                        case 'k':
                            return 75;
                        case 'l':
                            return 76;

                    }
                    return false;
                }

                resetLoop() {
                    if (this.interval) {
                        clearInterval(this.interval);
                    }
                    let i = 0;
                    this.interval = setInterval(() => {
                        if (i >= 16) {
                            i = 0;
                        }
                        let keyCode = this.getKeyCodeFromLetter(this.keys[i]);

                        if (keyCode) {
                            let e = new Event('keydown');
                            e.keyCode = keyCode;
                            window.dispatchEvent(e);
                        }
                        i++;
                    }, this.delay);
                }

                padEnd(string, length, character='.') {
                    while (string.length < length) {
                        string = string + character;
                    }

                    return string;
                }

                setDelay(delayInput) {
                    this.delay = delayInput.value;
                }

                updateKeys(e) {
                    this.setKeys(e.target);
                }

                updateDelay(e) {
                    this.setDelay(e.target);
                    this.resetLoop();
                }
            }

            const drumkit = new Drumkit();
            drumkit.enable();

            const keys = document.querySelector('input[name="loop"]');
            const delay = document.querySelector('input[name="loopDelay"]');
            const loop = new Loop(keys, delay);

        </script>


    </body>
</html>
