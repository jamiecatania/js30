<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>JS Drum Kit</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div class="keys">
            <div class="loop-container">
                <input type="range" id="loopDelay" name="loopDelay" min="100" max="300" value="200" step="10"/><br/>
                <input type="button" id="clearLoop" value="Clear Loop"/>
            </div><br/>
            <div data-key="65" class="key">
                <kbd>A</kbd>
                <span class="sound">clap</span><br/>
                <input type="checkbox" name="loop" data-beat="1" value="65"/>
                <input type="checkbox" name="loop" data-beat="2" value="65"/>
                <input type="checkbox" name="loop" data-beat="3" value="65"/>
                <input type="checkbox" name="loop" data-beat="4" value="65"/>
                <input type="checkbox" name="loop" data-beat="5" value="65"/>
                <input type="checkbox" name="loop" data-beat="6" value="65"/>
                <input type="checkbox" name="loop" data-beat="7" value="65"/>
                <input type="checkbox" name="loop" data-beat="8" value="65"/>
            </div>
            <div data-key="83" class="key">
                <kbd>S</kbd>
                <span class="sound">hihat</span>
                <br/>
                <input type="checkbox" name="loop" data-beat="1" value="83"/>
                <input type="checkbox" name="loop" data-beat="2" value="83"/>
                <input type="checkbox" name="loop" data-beat="3" value="83"/>
                <input type="checkbox" name="loop" data-beat="4" value="83"/>
                <input type="checkbox" name="loop" data-beat="5" value="83"/>
                <input type="checkbox" name="loop" data-beat="6" value="83"/>
                <input type="checkbox" name="loop" data-beat="7" value="83"/>
                <input type="checkbox" name="loop" data-beat="8" value="83"/>
            </div>
            <div data-key="68" class="key">
                <kbd>D</kbd>
                <span class="sound">kick</span>
                <br/>
                <input type="checkbox" name="loop" data-beat="1" value="68"/>
                <input type="checkbox" name="loop" data-beat="2" value="68"/>
                <input type="checkbox" name="loop" data-beat="3" value="68"/>
                <input type="checkbox" name="loop" data-beat="4" value="68"/>
                <input type="checkbox" name="loop" data-beat="5" value="68"/>
                <input type="checkbox" name="loop" data-beat="6" value="68"/>
                <input type="checkbox" name="loop" data-beat="7" value="68"/>
                <input type="checkbox" name="loop" data-beat="8" value="68"/>
            </div>
            <div data-key="70" class="key">
                <kbd>F</kbd>
                <span class="sound">openhat</span>
                <br/>
                <input type="checkbox" name="loop" data-beat="1" value="70"/>
                <input type="checkbox" name="loop" data-beat="2" value="70"/>
                <input type="checkbox" name="loop" data-beat="3" value="70"/>
                <input type="checkbox" name="loop" data-beat="4" value="70"/>
                <input type="checkbox" name="loop" data-beat="5" value="70"/>
                <input type="checkbox" name="loop" data-beat="6" value="70"/>
                <input type="checkbox" name="loop" data-beat="7" value="70"/>
                <input type="checkbox" name="loop" data-beat="8" value="70"/>
            </div>
            <div data-key="71" class="key">
                <kbd>G</kbd>
                <span class="sound">boom</span>
                <br/>
                <input type="checkbox" name="loop" data-beat="1" value="71"/>
                <input type="checkbox" name="loop" data-beat="2" value="71"/>
                <input type="checkbox" name="loop" data-beat="3" value="71"/>
                <input type="checkbox" name="loop" data-beat="4" value="71"/>
                <input type="checkbox" name="loop" data-beat="5" value="71"/>
                <input type="checkbox" name="loop" data-beat="6" value="71"/>
                <input type="checkbox" name="loop" data-beat="7" value="71"/>
                <input type="checkbox" name="loop" data-beat="8" value="71"/>
            </div>
            <div data-key="72" class="key">
                <kbd>H</kbd>
                <span class="sound">ride</span>
                <br/>
                <input type="checkbox" name="loop" data-beat="1" value="72"/>
                <input type="checkbox" name="loop" data-beat="2" value="72"/>
                <input type="checkbox" name="loop" data-beat="3" value="72"/>
                <input type="checkbox" name="loop" data-beat="4" value="72"/>
                <input type="checkbox" name="loop" data-beat="5" value="72"/>
                <input type="checkbox" name="loop" data-beat="6" value="72"/>
                <input type="checkbox" name="loop" data-beat="7" value="72"/>
                <input type="checkbox" name="loop" data-beat="8" value="72"/>
            </div>
            <div data-key="74" class="key">
                <kbd>J</kbd>
                <span class="sound">snare</span>
                <br/>
                <input type="checkbox" name="loop" data-beat="1" value="74"/>
                <input type="checkbox" name="loop" data-beat="2" value="74"/>
                <input type="checkbox" name="loop" data-beat="3" value="74"/>
                <input type="checkbox" name="loop" data-beat="4" value="74"/>
                <input type="checkbox" name="loop" data-beat="5" value="74"/>
                <input type="checkbox" name="loop" data-beat="6" value="74"/>
                <input type="checkbox" name="loop" data-beat="7" value="74"/>
                <input type="checkbox" name="loop" data-beat="8" value="74"/>
            </div>
            <div data-key="75" class="key">
                <kbd>K</kbd>
                <span class="sound">tom</span>
                <br/>
                <input type="checkbox" name="loop" data-beat="1" value="75"/>
                <input type="checkbox" name="loop" data-beat="2" value="75"/>
                <input type="checkbox" name="loop" data-beat="3" value="75"/>
                <input type="checkbox" name="loop" data-beat="4" value="75"/>
                <input type="checkbox" name="loop" data-beat="5" value="75"/>
                <input type="checkbox" name="loop" data-beat="6" value="75"/>
                <input type="checkbox" name="loop" data-beat="7" value="75"/>
                <input type="checkbox" name="loop" data-beat="8" value="75"/>
            </div>
            <div data-key="76" class="key">
                <kbd>L</kbd>
                <span class="sound">tink</span>
                <br/>
                <input type="checkbox" name="loop" data-beat="1" value="76"/>
                <input type="checkbox" name="loop" data-beat="2" value="76"/>
                <input type="checkbox" name="loop" data-beat="3" value="76"/>
                <input type="checkbox" name="loop" data-beat="4" value="76"/>
                <input type="checkbox" name="loop" data-beat="5" value="76"/>
                <input type="checkbox" name="loop" data-beat="6" value="76"/>
                <input type="checkbox" name="loop" data-beat="7" value="76"/>
                <input type="checkbox" name="loop" data-beat="8" value="76"/>
            </div>
        </div>

        <audio data-key="65" src="sounds/clap.wav"></audio>
        <audio data-key="83" src="sounds/hihat.wav"></audio>
        <audio data-key="68" src="sounds/kick.wav"></audio>
        <audio data-key="70" src="sounds/openhat.wav"></audio>
        <audio data-key="71" src="sounds/boom.wav"></audio>
        <audio data-key="72" src="sounds/ride.wav"></audio>
        <audio data-key="74" src="sounds/snare.wav"></audio>
        <audio data-key="75" src="sounds/tom.wav"></audio>
        <audio data-key="76" src="sounds/tink.wav"></audio>

        <script>
            HTMLAudioElement.prototype.rewind = function () {
                this.currentTime = 0;
            };

            HTMLAudioElement.prototype.playImmediately = function () {
                this.rewind();
                this.play();
            };

            class Drumkit {
                enable() {
                    this
                        .getKeys()
                        .forEach(key => key.addEventListener('transitionend', e => this.removeTransition(e)));

                    window.addEventListener('keydown', e => this.maybePlaySound(e));
                }

                getElementByKeyCode(elementType, keyCode) {
                    const selector = `${elementType}[data-key="${keyCode}"]`;
                    const element = document.querySelector(selector);

                    return element;
                }

                maybePlaySound(e) {
                    const audio = this.getElementByKeyCode('audio', e.keyCode);

                    if (!audio) {
                        return;
                    }

                    const key = this.getElementByKeyCode('div', e.keyCode);

                    key.classList.add('playing');

                    // Allow for playing one after another
                    audio.playImmediately();
                }

                removeTransition(e) {
                    if (e.propertyName !== 'transform') {
                        return;
                    }

                    e.target.classList.remove('playing');
                }

                getKeys() {
                    const keys = document.querySelectorAll('.key');
                    return keys;
                }
            }

            class Loop {
                constructor(delay) {
                    this.delay = document.querySelector('#loopDelay').value;
                    this.beat = 1;
                    this.play();
                    document.querySelector('#loopDelay').addEventListener('change', e => this.updateDelay(e));
                    document.querySelector('#clearLoop').addEventListener('click', () => this.clearLoop());
                }

                pressKey(keyCode) {
                    let e = new Event('keydown');
                    e.keyCode = keyCode;
                    window.dispatchEvent(e);
                }

                play() {
                    const checkboxes = document.querySelectorAll(`input[name="loop"][data-beat="${this.beat}"]`);
                    for (let i = 0; i < checkboxes.length; i++) {
                        if (checkboxes[i].checked) {
                            this.pressKey(checkboxes[i].value);
                        }
                    }
                    if (this.beat < 8) {
                        this.beat = this.beat + 1;
                    } else {
                        this.beat = 1;
                    }

                    setTimeout(() => this.play(), this.delay);
                }

                updateDelay(e) {
                    this.delay = e.target.value;
                }

                clearLoop() {
                    const checkboxes = document.querySelectorAll('input[name="loop"]');
                    for (let i = 0; i < checkboxes.length; i++) {
                        checkboxes[i].checked = false;
                    }
                }
            }

            const drumkit = new Drumkit();
            drumkit.enable();

            const loop = new Loop();
        </script>


    </body>
</html>
